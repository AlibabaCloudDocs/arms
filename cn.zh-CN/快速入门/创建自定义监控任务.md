# 创建自定义监控任务

对于高度定制化的业务场景，可以通过创建自定义监控任务来自由统计所需指标，生成需要的数据与报表，灵活地配置报警。本文以一个实例介绍了如何创建自定义监控任务。

**说明：** 自2019年04月15日起开通ARMS服务的新用户已关闭自定义监控功能，如需体验此功能，请在工单系统中[申请开通](https://selfservice.console.aliyun.com/ticket/createIndex)。

## 背景信息

首次使用ARMS时，ARMS会从日志流的尾部开始抓取日志进行处理。因此，请保证您的脚本或程序能够持续不断地输出日志。

目前ARMS支持StartAgent日志源、鹊桥数据源、MQ数据源。本文以StartAgent数据源为例。您需要在服务器上使用任意客户端生成文本格式的日志文件流。

在本实例中，我们在服务器的/home/admin/logs/arms/test.log中生成以下日志流：

```
2016-07-27 23:37:23|c0a895e114526786450161001d1ed9|9|EADS|BIZ-MONITOR|0|类目=女装&区域=上海&eventTeyp=3&性别=0&价格=20|iZ28ql4lx29Z
2016-07-27 23:37:23|c0a895e114526786450161001d1ed9|9|EADS|BIZ-MONITOR|0|类目=童装&区域=深圳&eventTeyp=3&性别=1&价格=30|iZ28ql4lx29Z        
```

**说明：** 这是一个简化版的交易系统日志流，日志的每一行代表一条交易记录。以“\|”分隔的各个字段分别表示交易成交时间、交易ID、交易详细信息等。

阅读本文后，您将了解到以下内容。

-   如何使用服务器上的日志文件流作为监控的数据源？
-   如何配置日志清洗方式、数据集和报警？
-   如何配置交互式数据大盘？

## 步骤一：接入数据源

1.  登录[ARMS控制台](https://arms.console.aliyun.com/#/home)。
2.  在控制台左侧导航栏中选择**自定义监控** \> **监控任务管理**。
3.  在实例列表页面，在右上角选择**新建监控任务** \> **新建自定义监控**，然后在新建自定义任务对话框中输入监控任务名称，并单击**新建并进行配置**。
4.  在数据源配置页签的日志源配置区域，输入所有必填信息。

    ![Log Source Configuration](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0830372061/p43489.png)

    1.  在**日志源类型**下拉框中选择**云服务器ECS**。
    2.  单击**添加日志源**，在弹出的选择日志源对话框中选择数据源，并输入日志路径 /home/admin/logs/arms/test.log。
    3.  在**编码设置**下拉框中选择**UTF-8**。编码设置默认为**自动探测**，但建议选择特定编码，避免出现乱码现象。
5.  在数据源配置页签的日志抓取结果区域，单击右上角的**日志抓取预览**。

    **说明：** ARMS会从选择的机器日志中抓取部分数据（最多20条）。由于需要建立预抓取的临时通道，一般需要30秒左右。

    日志抓取结果显示在预览窗口中。如果抓取不成功，请检查配置的日志路径和采集目标。

6.  在数据源配置页面单击**保存**，然后单击**下一步**。


## 步骤二：清洗日志

1.  在日志清洗页面上，单击智能切分标签页上的**获取方案**。

    **说明：** ARMS目前提供智能切分和自定义切分两种清洗方式。在本例中，由于日志格式比较简单，使用智能切分即可清洗出需要的键值对。

    智能切分器正确地判断出了样例日志是以“\|”分隔的，并按照这个规则自动切分出了 \_line\_gen\_0、\_line\_gen\_1等字段，其中\_line\_gen\_6字段是KV字符串，字符串内的字段也被自动切分出来了。

    ![Log Cleaning](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/4793709751/p43490.png)

2.  在日志清洗页面单击**保存**，然后单击**下一步**。


## 步骤三：配置数据集

1.  在**数据集设置**区域单击**添加数据集**。

![Dataset and Alarm Configuration](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0830372061/p43492.png)

2.  在**添加数据集**对话框输入相关信息，单击**保存**。

    示例1：统计每分钟订单数量

    因为每一行日志代表一个订单记录，所以只需要统计日志行数即可，即对 \_line进行COUNT运算。

    ![Add Dataset](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0830372061/p43493.png)

    示例2：统计每种类目的销售额

    选择下钻维度“类目”，并对“价格”进行SUM计算，每种订单商品数量为1。

    ![Add Dataset](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0830372061/p43496.png)

    创建的数据集显示在**数据集设置**区域中。

3.  在数据集与报警配置页面单击**保存**和**完成配置**。

4.  在**启动监控任务**对话框中，选择**从头开始消费**或**从最新位置消费**，并单击**确定**。 监控任务启动成功。稍等1-2分钟后，可进入任务详情查看数据集详情，也可以在数据集管理页面[查询数据集](/cn.zh-CN/自定义监控/使用教程/查询数据集.md)。


## 步骤四：添加报警

1.  在控制台左侧导航栏中选择**报警管理** \> **报警策略管理**。

2.  在报警规则和历史页面，选择右上角的**创建报警** \> **自定义监控报警**。

3.  在创建报警对话框中输入相关信息，并单击**保存**。 示例：设置最近10分钟订单量低于指定下限值的报警。

![Create Alarm](https://static-aliyun-doc.oss-accelerate.aliyuncs.com/assets/img/zh-CN/0830372061/p43498.png)

4.  在报警规则列表找到上一步创建的报警，单击右侧的**启动**，启动该报警规则。


